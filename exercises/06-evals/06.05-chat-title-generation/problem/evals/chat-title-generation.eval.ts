import { google } from '@ai-sdk/google';
import { generateObject, generateText } from 'ai';
import { createScorer, evalite } from 'evalite';
import { readFileSync } from 'fs';
import Papa from 'papaparse';
import path from 'path';
import { z } from 'zod';

const csvFile = readFileSync(
  path.join(import.meta.dirname, '../../titles-dataset.csv'),
  'utf-8',
);

const data = Papa.parse<{ Input: string; Output: string }>(
  csvFile,
  {
    header: true,
    skipEmptyLines: true,
  },
);

const EVAL_DATA_SIZE = 15;

const dataForEvalite = data.data
  .slice(0, EVAL_DATA_SIZE)
  .map((row) => ({
    input: row.Input,
    expected: row.Output,
  }));

  const titleQualityScorer = createScorer<string, string, string>({
    name: 'Title quality',
    scorer: async ({ input, output, expected }) => {
      const result = await generateObject({
        model: google('gemini-2.0-flash-lite'),
        system: `You are a helpful assistant that can generate titles for chat conversations.
        Your job is to evaluate the quality of the title generated by the assistant.
        Reply with a score of A, B or C.

        A: The title is a good quality title.
        B: The title is a bad quality title.
        C: The title is not a title or is not relevant to the conversation or don't follow the output format.
        `,
        messages: [
          {
            role: 'user',
            content: [
              {
                type: 'text',
                text: input,
              },
            ],
          },
          {
            role: 'assistant',
            content: output,
          },
        ],
        schema: z.object({
          score: z.enum(['A', 'B', 'C']),
          feedback: z.string().describe('A short feedback message about the title.'),
        }),
      });

      const scoreMap = {
        A: 1,
        B: 0.5,
        C: 0,
      } as const;

      return {
        score: scoreMap[result.object.score],
        metadata: result.object.feedback,
      };
    },
  });

evalite('Chat Title Generation', {
  data: () => dataForEvalite,
  task: async (input) => {
    const result = await generateText({
      model: google('gemini-2.0-flash-lite'),
      prompt: `
        <task-context>
        You are a helpful assistant that can generate titles for chat conversations.
        </task-context>

        <input>
        ${input}
        </input>

        <output-format>
        Generate me a title for the chat conversation.
        No more than 50 characters.
        No punctuation, emojis or question marks.
        </output-format>
      `,
    });

    return result.text;
  },
  scorers: [
    {
      name: 'Output length',
      scorer: ({ input, output, expected }) => {
        return output.length <= 50 ? 1 : 0;
      },
    },
    {
      name: 'No punctuation',
      scorer: ({ input, output, expected }) => {
        return !output.includes('!') && !output.includes('?') && !output.includes('!') ? 1 : 0;
      },
    },
    titleQualityScorer,
  ],
});
